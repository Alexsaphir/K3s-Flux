---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tandoor-recipes
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-charts
      interval: 15m

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  values:
    image:
      repository: ghcr.io/tandoorrecipes/recipes
      tag: 1.5.4
    envFrom:
      - secretRef:
          name: tandoor-recipes-secret
    env:
      TIMEZONE: '${CONFIG_TIMEZONE}'

      ALLOWED_HOSTS: &host recipes.${SECRET_DOMAIN_NAME}
      SESSION_COOKIE_DOMAIN: *host
      SESSION_COOKIE_NAME: tandoor-recipes-sessionid

      DB_ENGINE: django.db.backends.postgresql
      POSTGRES_HOST:
        valueFrom:
          secretKeyRef:
            name: database-tandoor-recipes
            key: HOST
      POSTGRES_PORT: '5432'
      POSTGRES_DB:
        valueFrom:
          secretKeyRef:
            name: database-tandoor-recipes
            key: DATABASE_NAME
      POSTGRES_USER:
        valueFrom:
          secretKeyRef:
            name: database-tandoor-recipes
            key: LOGIN
      POSTGRES_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: database-tandoor-recipes
            key: PASSWORD

      # S3 storage
      S3_BUCKET_NAME: recipes
      S3_REGION_NAME: us-east-1
      S3_QUERYSTRING_AUTH: 1
      S3_QUERYSTRING_EXPIRE: 3600

      DEBUG: 0
      GUNICORN_MEDIA: 0
      ENABLE_SIGNUP: 0
      ENABLE_METRICS: 1
      ENABLE_PDF_EXPORT: 1

      # Users default preference
      FRACTION_PREF_DEFAULT: 1
      COMMENT_PREF_DEFAULT: 1
      SHOPPING_MIN_AUTOSYNC_INTERVAL: 5

      # Default settings for spaces
      SPACE_DEFAULT_MAX_RECIPES: 5000 # 0=unlimited recipes
      SPACE_DEFAULT_MAX_USERS: 0 # 0=unlimited users per space
      SPACE_DEFAULT_MAX_FILES: 512 # Maximum file storage for space in MB. 0 for unlimited, -1 to disable file upload.
      SPACE_DEFAULT_ALLOW_SHARING: 1 # Allow users to share recipes with public links

      SORT_TREE_BY_NAME: 1

      # LDAP auth
      LDAP_AUTH: 1
      AUTH_LDAP_SERVER_URI: ldap://glauth.network-system.svc.cluster.local:389
      AUTH_LDAP_BIND_DN: cn=search_recipes,ou=svcaccts,dc=home,dc=arpa
      AUTH_LDAP_USER_SEARCH_BASE_DN: ou=people,ou=users,dc=home,dc=arpa

      AUTH_LDAP_ALWAYS_UPDATE_USER: 1
      AUTH_LDAP_CACHE_TIMEOUT: 3600
      AUTH_LDAP_USER_ATTR_MAP: "{'first_name': 'givenName', 'last_name': 'sn', 'email': 'mail' }"
      AUTH_LDAP_USER_SEARCH_FILTER_STR: "(&(uid=%(user)s)(memberOf=ou=recipes,ou=groups,dc=home,dc=arpa))"


    service:
      main:
        ports:
          http:
            port: 8080
    ingress:
      main:
        enabled: true
        ingressClassName: traefik
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: network-system-authelia-auth@kubernetescrd
          hajimari.io/icon: mdi:cookie
        hosts:
          - host: *host
            paths:
              - path: /
                pathType: Prefix

    persistence:
      static:
        enabled: true
        mountPath: /opt/recipes/staticfiles
        size: 20Gi
        storageClass: longhorn
        accessMode: ReadWriteOnce
