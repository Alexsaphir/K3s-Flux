---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app datalore
spec:
  interval: 15m
  timeout: 20m
  chart:
    spec:
      chart: datalore
      version: 8.7.3
      sourceRef:
        kind: HelmRepository
        name: datalore
        namespace: flux-charts
      interval: 15m

  driftDetection:
    mode: enabled
  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  valuesFrom:
    - kind: Secret
      name: &database-secret database-jetbrains-datalore
      valuesKey: LOGIN
      targetPath: dataloreEnv.DB_USER
    - kind: Secret
      name: *database-secret
      valuesKey: POSTGRES_JDBC_URL
      targetPath: dataloreEnv.DB_URL

  # https://github.com/JetBrains/datalore-configs/blob/2024.5/charts/datalore/values.yaml
  values:
    # Configure external postgres
    internalDatabase: false
    databaseSecret:
      create: false
      name: *database-secret
      key: PASSWORD

    dataloreEnv:
      DATALORE_PUBLIC_URL: '{{ printf "https://%s" (first .Values.ingress.app.hosts).host }}'

      DATABASES_K8S_NAMESPACE: '{{ .Release.Namespace }}'
      GIT_TASK_K8S_NAMESPACE: '{{ .Release.Namespace }}'

    ingress:
      enabled: true
      hosts:
        - host: datalore.${DOMAIN_NAME}
          paths:
            - path: /
              pathType: Prefix

    agentsConfig:
      k8s:
        namespace: '{{ .Release.Namespace }}'

    volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: *app
