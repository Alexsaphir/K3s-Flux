---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: renovate
  namespace: flux-ci
spec:
  chart:
    spec:
      # renovate: datasource=github-releases depName=whitesource/renovate-on-prem
      chart: ./helm-charts/whitesource-renovate
      version: 2.6.0
      sourceRef:
        kind: GitRepository
        name: renovate-chart-git
        namespace: flux-charts
  interval: 15m
  timeout: 5m
  values:
    image:
      repository: whitesource/renovate
      tag: 2.6.0
      pullPolicy: IfNotPresent

    renovate:
      acceptWhiteSourceTos: 'y'

      renovatePlatform: 'gitlab'
      renovateEndpoint: 'https://${SECRET_GITLAB_DOMAIN}/api/v4/'

      schedulerCron: '*/5 * * * *'

      #      extraEnvVars:
      #        - name: RENOVATE_GIT_PRIVATE_KEY
      #          value: "${SECRET_RENOVATE_GIT_PRIVATE_KEY}"

      # valueFrom: {{ include "whitesource-renovate.secret-name" . }}
      # key: gitPrivateKey

      config: |
        module.exports = {
          // Enter self-hosted configuration options here.
          // https://docs.renovatebot.com/self-hosted-configuration/
          onboardingConfig: {
            extends: ['config:base',":gitSignOff", ":rebaseStalePrs",":enablePreCommit"],
          },
          gitPrivateKey: '${SECRET_RENOVATE_GIT_PRIVATE_KEY}',
          gitAuthor: '${SECRET_RENOVATE_GIT_AUTHOR}',

          autodiscover: true,
          onboarding: true,
          requireConfig: 'required',

          persistRepoData: true,
          baseDir: '/tmp/renovate'
        }

      logLevel: debug

      cachePersistence:
        enabled: true
        accessModes:
          - ReadWriteOnce
          ## Persistent Volume size
        size: 1Gi
        ## The name of an existing PVC to use for persistence
        existingClaim: ""

      existingSecret: whitesource-renovate
