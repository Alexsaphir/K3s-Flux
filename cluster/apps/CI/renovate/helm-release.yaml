---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: renovate
  namespace: flux-ci
spec:
  interval: 15m
  chart:
    spec:
      chart: whitesource-renovate
      version: 3.1.3
      sourceRef:
        kind: HelmRepository
        name: renovate-on-prem
        namespace: flux-charts
      interval: 15m

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  # https://github.com/mend/renovate-on-prem/blob/main/helm-charts/whitesource-renovate/values.yaml
  values:
    image:
      # renovate: datasource=github-releases depName=mend/renovate-on-prem
      tag: 4.0.0

    fullnameOverride: 'whitesource-renovate'

    renovate:
      acceptWhiteSourceTos: 'y'

      renovatePlatform: 'gitlab'
      renovateEndpoint: 'https://${SECRET_GITLAB_DOMAIN}/api/v4/'

      schedulerCron: '0/15 * * * *'

      #      extraEnvVars:
      #        - name: RENOVATE_GIT_PRIVATE_KEY
      #          value: "${SECRET_RENOVATE_GIT_PRIVATE_KEY}"

      # valueFrom: {{ include "whitesource-renovate.secret-name" . }}
      # key: gitPrivateKey

      extraEnvVars:
        - name: DOCKER_HUB_USER
          valueFrom:
            secretKeyRef:
              name: renovate-dockerhub-credentials
              key: username
        - name: DOCKER_HUB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: renovate-dockerhub-credentials
              key: password

        - name: RENOVATE_ONBOARDING_CONFIG
          valueFrom:
            configMapKeyRef:
              name: renovate-onboarding-config
              key: onboardingConfig

      config: |
        module.exports = {
          // Enter self-hosted configuration options here.
          // https://docs.renovatebot.com/self-hosted-configuration/
          onboardingConfig: {
            extends: ['config:base',":gitSignOff", ":rebaseStalePrs",":enablePreCommit"],
          },
          gitPrivateKey: '${SECRET_RENOVATE_GIT_PRIVATE_KEY}',
          gitAuthor: '${SECRET_RENOVATE_GIT_AUTHOR}',

          hostRules: [
            {
              hostType: 'docker',
              "matchHost": "docker.io",
              username: process.env.DOCKER_HUB_USER,
              password: process.env.DOCKER_HUB_PASSWORD,
            },
          ],

          autodiscover: true,
          requireConfig: 'required',
          onboarding: true,
          onboardingNoDeps: true,
          onboardingConfigFileName: '.gitlab/renovate.json5',

          binarySource: 'install',

          persistRepoData: true,
          baseDir: '/tmp/renovate'
        }

      logLevel: info

      cachePersistence:
        enabled: true
        storageClass: "longhorn"
        accessModes:
          - ReadWriteOnce
        size: 1Gi

      existingSecret: whitesource-renovate

  postRenderers:
    - kustomize:
        patchesJson6902:
          - patch:
              - op: add
                path: /spec/template/metadata/annotations
                value:
                  configmap.reloader.stakater.com/reload: "renovate-config-js,renovate-onboarding-config"
                  secret.reloader.stakater.com/reload: "renovate-dockerhub-credentials,whitesource-renovate"
            target:
              kind: Deployment
              name: whitesource-renovate
              namespace: flux-ci
