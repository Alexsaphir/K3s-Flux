---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: codecov
spec:
  interval: 15m
  chart:
    spec:
      chart: codecov
      version: 5.0.0
      sourceRef:
        kind: HelmRepository
        name: codecov
        namespace: flux-charts
      interval: 15m

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  valuesFrom:
    - kind: Secret
      name: codecov-secret
      valuesKey: enterprise_license
      targetPath: codecovConfig.setup.enterprise_license
    - kind: Secret
      name: codecov-secret
      valuesKey: cookie_secret
      targetPath: codecovConfig.setup.http.cookie_secret

    - kind: Secret
      name: codecov-gitlab-secret
      valuesKey: client_id
      targetPath: codecovConfig.gitlab_enterprise.client_id
    - kind: Secret
      name: codecov-gitlab-secret
      valuesKey: client_secret
      targetPath: codecovConfig.gitlab_enterprise.client_secret

    - kind: Secret
      name: codecov-s3-secret
      valuesKey: access_key
      targetPath: codecovConfig.services.minio.access_key_id
    - kind: Secret
      name: codecov-s3-secret
      valuesKey: secret_key
      targetPath: codecovConfig.services.minio.secret_access_key

    - kind: Secret
      name: database-codecov
      valuesKey: POSTGRES_URL
      targetPath: codecovConfig.services.database_url
    - kind: Secret
      name: database-codecov-timeseries
      valuesKey: POSTGRES_URL
      targetPath: codecovConfig.services.timeseries_database_url

  values:
    codecovVersion: 23.11.2
    configmap:
      name: &configmap-name codecov-yml

    demo:
      enabled: false

    codecovConfig:
      github: null

      gitlab_enterprise:
        global_upload_token: 'glab-sph'
        url: 'https://gitlab.alexsaphir.com'

      services:
        minio:
          host: s3.alexsaphir.com
          bucket: codecov
          region: us-east-1
          verify_ssl: true

        redis_url: redis://codecov-redis.codecov.svc.cluster.local:6379
      setup:
        codecov_url: &codecov_url "https://codecov.${SECRET_DOMAIN_NAME}"
        codecov_api_url: *codecov_url

        guest_access: off


        admins:
          - service: gitlab_enterprise
            username: Saphir
          - service: gitlab_enterprise
            username: Alexsaphir
          - service: gitlab_enterprise
            username: &codecov-bot Codecov

      site:
        bot: *codecov-bot

    ingress:
      enabled: true
      annotations:
        # traefik.ingress.kubernetes.io/router.middlewares: network-system-authelia-auth@kubernetescrd
        auth.home.arpa/disabled: "true"
        hajimari.io/enable: "true"
      name: codecov-ingress
      pathtype: ImplementationSpecific
      className: traefik
      paths:
        root:
          path: /
          service: gateway
          port: 8080
      hosts:
        - &host codecov.${SECRET_DOMAIN_NAME}

    extraEnvs:
      - name: CODECOV_FRONTEND_IPV6_DISABLED
        value: 'true'
      - name: RUN_ENV
        value: ENTERPRISE

    tags:
      'configmap.reloader.stakater.com/reload': *configmap-name

    frontend:
      image: codecov/self-hosted-frontend
      deployment:
        replicas: &replica-count 2
        env:
          - name: CODECOV_BASE_HOST
            value: *host
          - name: CODECOV_API_HOST
            value: *host
          - name: CODECOV_IA_HOST
            value: *host
          - name: CODECOV_SCHEME
            value: https
        resources:
          #      limits:
          #        cpu: 1000m
          #        memory: 2048M
          requests:
            cpu: 250m
            memory: 256M
      service:
        annotations: { }
        port: 8080
        type: &service-type ClusterIP
    gateway:
      image: codecov/self-hosted-gateway
      deployment:
        replicas: *replica-count
        env:
          - name: CODECOV_GATEWAY_MINIO_ENABLED
            value: 'true'
        resources:
          #      limits:
          #        cpu: 1000m
          #        memory: 2048M
          requests:
            cpu: 250m
            memory: 256M
      service:
        annotations: { }
        port: 8080
        type: *service-type
    api:
      image: codecov/self-hosted-api
      deployment:
        replicas: *replica-count
        resources:
          limits:
            cpu: 1000m
            memory: 2048M
          requests:
            cpu: 250m
            memory: 256M
      service:
        annotations: { }
        port: 8000
        type: *service-type

    worker:
      image: codecov/self-hosted-worker
      deployment:
        replicas: 2
        args: [ ]
        resources:
          limits:
            cpu: 3000m  # limit to number of CPU cores available if possible (1000 * cores)
            memory: 4096M
          requests:
            cpu: 500m
            memory: 1024M
