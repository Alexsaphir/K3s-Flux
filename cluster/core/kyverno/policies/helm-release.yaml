---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kyverno-policies
  namespace: kyverno
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix-charts
        namespace: flux-charts
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  dependsOn:
    - name: kyverno
      namespace: kyverno

  values:
    - apiVersion: kyverno.io/v1
      kind: ClusterPolicy
      metadata:
        name: delete-cpu-limits
        annotations:
          policies.kyverno.io/title: Delete CPU limits
          policies.kyverno.io/subject: Pod
          policies.kyverno.io/description: >-
            This policy deletes CPU limits from all Pods.
      spec:
        mutateExistingOnPolicyUpdate: true
        generateExistingOnPolicyUpdate: true
        rules:
          - name: delete-cpu-limits
            match:
              any:
                - resources:
                    kinds: [ "Pod" ]
            exclude:
              any:
                - resources:
                    namespaces:
                      - calico-system
                      - tigera-operator
                - resources:
                    kinds: [ "Pod" ]
                    selector:
                      matchLabels:
                        job-name: "*"
                - resources:
                    kinds: [ "Pod" ]
                    selector:
                      matchLabels:
                        statefulset.kubernetes.io/pod-name: "*"
                - resources:
                    annotations:
                      kyverno.io/ignore: "true"
            mutate:
              patchStrategicMerge:
                spec:
                  initContainers:
                    - (name): "*"
                      resources:
                        limits:
                          cpu: null
                  containers:
                    - (name): "*"
                      resources:
                        limits:
                          cpu: null
