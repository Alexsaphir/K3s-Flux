---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik-authelia-middlewares
  namespace: network-system
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.2
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-charts

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  dependsOn:
    - name: traefik
      namespace: network-system

  values:
    resources:
      - apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: authelia-auth
          namespace: network-system
        spec:
          forwardAuth:
            address: 'http://authelia.network-system.svc.cluster.local/api/verify?rd=https://auth.${SECRET_DOMAIN_NAME}'
            trustForwardHeader: true
            authResponseHeaders:
              - Remote-User
              - Remote-Name
              - Remote-Email
              - Remote-Groups

      - apiVersion: traefik.containo.us/v1alpha1
        kind: Middleware
        metadata:
          name: authelia-headers
          namespace: network-system
        spec:
          headers:
            browserXssFilter: true
            customFrameOptionsValue: "SAMEORIGIN"
            customResponseHeaders:
              Cache-Control: "no-store"
              Pragma: "no-cache"
