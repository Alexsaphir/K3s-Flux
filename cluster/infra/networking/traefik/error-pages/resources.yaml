---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: error-pages-resources
  namespace: network-system
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-charts

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  dependsOn:
    - name: traefik
      namespace: network-system

    - name: error-pages
      namespace: network-system

  values:
    resources:
      - apiVersion: traefik.io/v1alpha1
        kind: IngressRoute
        metadata:
          name: error-pages
          namespace: network-system
        spec:
          entryPoints:
            - web
            - websecure
          routes:
            - kind: Rule
              match: HostRegexp(`{host:.+}`)
              priority: 1
              middlewares:
                - name: error-pages-network-system@kubernetescrd
              services:
                - kind: Service
                  name: error-pages
                  namespace: network-system
                  port: 8080

      - apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: error-pages
          namespace: network-system
        spec:
          errors:
            status:
              - "300-300"
              - "303-306"
              - "308-599"
            query: /{status}.html
            service:
              name: error-pages
              port: 8080
