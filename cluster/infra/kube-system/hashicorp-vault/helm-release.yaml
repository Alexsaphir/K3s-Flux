---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hashicorp-vault
  namespace: kube-system
spec:
  interval: 15m
  chart:
    spec:
      chart: vault
      version: 0.23.0

      sourceRef:
        kind: HelmRepository
        name: hashicorp
        namespace: flux-charts
      interval: 15m

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  dependsOn:
    - name: secrets-store-csi-driver
      namespace: kube-system

  # https://github.com/hashicorp/vault-helm/blob/main/values.yaml
  values:
    global:
      enabled: false

    server:
      enabled: true
      updateStrategyType: RollingUpdate

      # Supported log levels include: trace, debug, info, warn, error
      # Supported log formats include: standard, json
      logLevel: "info"
      logFormat: "json"

      readinessProbe:
        enabled: true
        path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"


      ingress:
        enabled: true
        ingressClassName: traefik
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: shield-key

        hosts:
          - host: vault.${SECRET_DOMAIN_NAME}
            paths:
              - /

      dataStorage:
        enabled: true
        size: 10Gi
        storageClass: longhorn

      auditStorage:
        enabled: false
        size: 10Gi
        storageClass: longhorn

      extraLabels:
        configmap.reloader.stakater.com/reload: hashicorp-vault-config

      extraEnvironmentVars:
        TZ: ${CONFIG_TIMEZONE}

      #      extraVolumes:
      #        - type: secret
      #          name: kms-vault-unseal
      #          path: /vault/userconfig

      # Run Vault in "standalone" mode. This is the default mode that will deploy if
      # no arguments are given to helm. This requires a PVC for data storage to use
      # the "file" backend.  This mode is not highly available and should not be scaled
      # past a single replica.
      standalone:
        enabled: "true"
        config: |
          ui = true

          cluster_name = "sph-prod"

          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
          }
          storage "file" {
            path = "/vault/data"
          }

          # Example configuration for enabling Prometheus metrics in your config.
          # Enable unauthenticated metrics access (necessary for Prometheus Operator)
          #telemetry {
          #  unauthenticated_metrics_access = "true"
          #  prometheus_retention_time = "30s"
          #  disable_hostname = true
          #}

    # Vault UI
    ui:
      enabled: true
      serviceType: "ClusterIP"

      externalTrafficPolicy: Cluster
