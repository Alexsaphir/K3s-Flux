---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-auth
  namespace: kyverno
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-charts
      interval: 15m

  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  dependsOn:
    - name: kyverno
      namespace: kyverno

  values:
    resources:
      - apiVersion: kyverno.io/v1
        kind: ClusterPolicy
        metadata:
          name: update-ingress-annotations
          annotations:
            policies.kyverno.io/title: Update ingress annotations
            policies.kyverno.io/subject: Ingress
            policies.kyverno.io/description: >-
              This policy creates auth annotations on ingresses.
        spec:
          validationFailureAction: Enforce
          generateExisting: true
          rules:
            - name: auth
              match:
                any:
                  - resources:
                      kinds: [ "Ingress" ]
              exclude:
                any:
                  - resources:
                      annotations:
                        auth.home.arpa/disabled: "true"

              mutate:
                patchStrategicMerge:
                  metadata:
                    annotations:
                      +(nginx.ingress.kubernetes.io/auth-method): GET
                      +(nginx.ingress.kubernetes.io/auth-url): |-
                        http://authelia.network-system.svc.cluster.local/api/verify
                      +(nginx.ingress.kubernetes.io/auth-signin): |-
                        https://auth.${SECRET_DOMAIN_NAME}?rm=$request_method
                      +(nginx.ingress.kubernetes.io/auth-response-headers): |-
                        Remote-User,Remote-Name,Remote-Groups,Remote-Email
                      +(nginx.ingress.kubernetes.io/auth-snippet): |
                        proxy_set_header X-Forwarded-Method $request_method;
