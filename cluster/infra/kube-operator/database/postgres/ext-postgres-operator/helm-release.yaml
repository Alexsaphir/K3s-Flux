---
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: movetokube-cluster-postgres
spec:
  interval: 1h
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 3.0.0
  url: oci://ghcr.io/movetokube/postgres-operator/charts/ext-postgres-operator
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: movetokube-cluster-postgres
spec:
  interval: 15m
  chartRef:
    kind: OCIRepository
    name: movetokube-cluster-postgres

  driftDetection:
    mode: enabled
  maxHistory: 3
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3

  valuesFrom:
    - kind: Secret
      name: postgres-superuser
      valuesKey: username
      targetPath: postgres.user
    - kind: Secret
      name: postgres-superuser
      valuesKey: password
      targetPath: postgres.password

  values:
    image:
      repository: ghcr.io/movetokube/postgres-operator
      tag: 2.4.0@sha256:def57d85a2dab9b5f1f50dded8b066aa9742fb8e5eaf111ac805d9755899492b

    podAnnotations:
      reloader.stakater.com/auto: 'true'

    postgres:
      host: postgres-rw.database.svc.cluster.local
      default_database: 'postgres'

    resources:
      requests:
        cpu: 5m
        memory: 32M
