---
version: "3"

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"
  CLUSTER_DIR: "{{.PROJECT_DIR}}/cluster"
  ANSIBLE_DIR: "{{.PROJECT_DIR}}/provision/ansible"
  TERRAFORM_DIR: "{{.PROJECT_DIR}}/provision/terraform"
  VAGRANT_DIR: "{{.PROJECT_DIR}}/provision/vagrant"

dotenv: [ ".config.env" ]

includes:
  precommit: .taskfiles/PrecommitTasks.yml
  tools: .taskfiles/ToolsTasks.yml
  age: .taskfiles/AgeTasks.yml
  cluster: .taskfiles/ClusterTasks.yml
  ansible: .taskfiles/AnsibleTasks.yml

tasks:
  default:
    - task: precommit:run

  init:
    desc: Initialize workstation
    cmds:
      - task: precommit:init
      - task: tools:install
      - task: age:init
      - task: ansible:init

  install:
    desc: Install K3s on the cluster
    cmds:
      - task: ansible:prepare
      - task: ansible:install

  update:
    desc: Run update
    cmds:
      - task: precommit:update
      - task: tools:update
      - task: ansible:init
      - task: ansible:install
