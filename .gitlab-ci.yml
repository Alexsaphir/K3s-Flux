---
variables:
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

default:
  interruptible: true

stages:
  - oci
  - quality
  - deploy

.arkade:
  image: ubuntu
  before_script:
    - apt update && apt install -qy curl python3 python3-yaml
    - curl -sLS https://get.arkade.dev | sh
    - arkade get flux
    - arkade get kubectl
    - export PATH=$PATH:$HOME/.arkade/bin/

'create-oci':
  stage: oci
  extends:
    - .arkade
  script:
    - apt install -qy wget unzip
    - wget https://github.com/datreeio/CRDs-catalog/releases/download/v0.0.11/crd-extractor.zip
    - unzip crd-extractor.zip
    - export HOME=$CI_PROJECT_DIR
    - mkdir -p $CI_PROJECT_DIR/crdSchemas
    - bash crd-extractor.sh
    - mv ${HOME}/.datree/crdSchemas $CI_PROJECT_DIR/crdSchemas
    - |
      flux push artifact oci://${CI_REGISTRY_IMAGE}/kubernetes-schemas-oci:${CI_COMMIT_SHA} \
      --path=$CI_PROJECT_DIR/crdSchemas \
      --source=${CI_REPOSITORY_URL} \
      --revision="${CI_COMMIT_REF_NAME}@sha1:${CI_COMMIT_SHA}" \
      --creds ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}
  artifacts:
    paths:
      - crdSchemas/

kubeconform:
  stage: quality
  extends:
    - .arkade
  script:
    - arkade get kubeconform kustomize
    - |
      bash ./.gitlab/scripts/kubeconform.sh \
      ${CI_PROJECT_DIR}/cluster \
      ${CI_PROJECT_DIR}/crdSchemas \
      1.27

'publish-oci':
  stage: deploy
  image: ubuntu
  only:
    - tags
  dependencies:
    - 'create-oci'
  before_script:
    - apt update && apt install -qy curl
    - curl -sLS https://get.arkade.dev | sh
    - arkade get flux
    - export PATH=$PATH:$HOME/.arkade/bin/
  script:
    - |
      flux push artifact oci://${CI_REGISTRY_IMAGE}/kubernetes-schemas-oci:${CI_COMMIT_SHA} \
      --path=$CI_PROJECT_DIR/crdSchemas \
      --source=${CI_REPOSITORY_URL} \
      --revision="${CI_COMMIT_REF_NAME}@sha1:${CI_COMMIT_SHA}" \
      --creds ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}

'publish-oci-web':
  stage: deploy
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [ "" ]
  dependencies:
    - 'create-oci'
  script:
    - |
      cat <<EOF > $CI_PROJECT_DIR/crdSchemas/Dockerfile
      FROM docker.io/nginxinc/nginx-unprivileged:latest
      COPY --chown=nginx:nginx --chmod=755 . /usr/share/nginx/html
      USER nginx
      EOF
    - /kaniko/executor
      --context $CI_PROJECT_DIR/crdSchemas
      --dockerfile $CI_PROJECT_DIR/crdSchemas/Dockerfile
      --destination $CI_REGISTRY_IMAGE/kubernetes-schemas-web:latest

pages:
  stage: deploy
  image: rust
  variables:
    CARGO_HOME: $CI_PROJECT_DIR/cargo
  before_script:
    - export PATH="$PATH:$CARGO_HOME/bin"
    - |
      mdbook --version || cargo install mdbook \
                                        mdbook-open-git-repo \
                                        mdbook-linkcheck \
                                        mdbook-toc \
                                        mdbook-emojicodes \
                                        mdbook-linkcheck
  script:
    - mdbook build -d ../public docs
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  artifacts:
    paths:
      - public
  cache:
    paths:
      - $CARGO_HOME/bin
