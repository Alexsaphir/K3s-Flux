---
version: "3"

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"
  CLUSTER_DIR: "{{.PROJECT_DIR}}/cluster"
  ANSIBLE_DIR: "{{.PROJECT_DIR}}/provision/ansible"
  TERRAFORM_DIR: "{{.PROJECT_DIR}}/provision/terraform"
  VAGRANT_DIR: "{{.PROJECT_DIR}}/provision/vagrant"

dotenv: [ ".config.env", ".flux.env" ]

includes:
  precommit: .taskfiles/PrecommitTasks.yaml
  tools: .taskfiles/ToolsTasks.yaml
  age: .taskfiles/AgeTasks.yaml
  cluster: .taskfiles/ClusterTasks.yaml
  cluster-debug: .taskfiles/ClusterDebugTasks.yaml
  debug: .taskfiles/DebugTasks.yaml
  ansible: .taskfiles/AnsibleTasks.yaml
  vagrant: .taskfiles/VagrantTasks.yaml
  flux: .taskfiles/FluxTasks.yaml
  gpg: .taskfiles/GpgTasks.yaml

tasks:
  default:
    - task: precommit:run

  commit:
    desc: Fully deployed tools and flux
    cmds:
      - task: init
      - task: update
      - task: install

  init:
    desc: Initialize workstation
    cmds:
      - task: precommit:init
      - task: tools:install
      - task: age:init
      - task: ansible:init

  install:
    desc: Install K3s on the cluster
    cmds:
      - task: ansible:prepare
      - task: ansible:install
      - task: flux:install

  update:
    desc: Run update
    cmds:
      - task: tools:update
      - task: precommit:update
      - task: ansible:init
      - task: install
